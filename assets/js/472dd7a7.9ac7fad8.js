"use strict";(self.webpackChunkrifflab_docs=self.webpackChunkrifflab_docs||[]).push([[907],{1639:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>d});var a=t(5893),o=t(1151);const i={sidebar_position:3},r="The Bootstrap",s={id:"build/getting-airborne/the-bootstrap",title:"The Bootstrap",description:"We have a problem.",source:"@site/docs/build/getting-airborne/the-bootstrap.md",sourceDirName:"build/getting-airborne",slug:"/build/getting-airborne/the-bootstrap",permalink:"/docs/build/getting-airborne/the-bootstrap",draft:!1,unlisted:!1,editUrl:"https://github.com/riffcc/rifflabs/tree/main/packages/create-docusaurus/templates/shared/docs/build/getting-airborne/the-bootstrap.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"buildSidebar",previous:{title:"Building the base playbook",permalink:"/docs/build/getting-airborne/building-the-base-playbook"}},l={},d=[{value:"What is Foreman?",id:"what-is-foreman",level:2},{value:"The plan",id:"the-plan",level:2},{value:"Setting up Foreman",id:"setting-up-foreman",level:2},{value:"Creating a new VM",id:"creating-a-new-vm",level:3},{value:"Installing Foreman",id:"installing-foreman",level:3},{value:"Configuring Foreman",id:"configuring-foreman",level:3},{value:"Subnets",id:"subnets",level:4},{value:"Location and Organisation",id:"location-and-organisation",level:4}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",p:"p",pre:"pre",strong:"strong",...(0,o.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"the-bootstrap",children:"The Bootstrap"}),"\n",(0,a.jsx)(n.p,{children:"We have a problem."}),"\n",(0,a.jsx)(n.p,{children:"We have three or more Proxmox nodes, capable of hosting VMs, but we have only a single VM."}),"\n",(0,a.jsx)(n.p,{children:"We need to be able to create more VMs, and we need to be able to do it quickly and easily."}),"\n",(0,a.jsxs)(n.p,{children:["Enter ",(0,a.jsx)(n.a,{href:"https://theforeman.org/",children:"The Foreman"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"what-is-foreman",children:"What is Foreman?"}),"\n",(0,a.jsx)(n.p,{children:"Foreman is a bare metal machine provisioning system. It allows you to provision hosts with an operating system automatically."}),"\n",(0,a.jsx)(n.h2,{id:"the-plan",children:"The plan"}),"\n",(0,a.jsx)(n.p,{children:"We'll first setup Foreman within a VM, and then use it to provision the rest of our VMs. Later, once all of our VMs have been setup, we'll lay a Kubernetes cluster over the top of them, spawn a highly available PostgreSQL cluster, and then make Foreman highly available too."}),"\n",(0,a.jsx)(n.p,{children:"Once this is done, interestingly, we'll be able to use Foreman to re-provision and reinstall any machine in the lab, including the machines that are running Foreman itself."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Boots within boots",src:t(7555).Z+"",width:"1024",height:"1024"})}),"\n",(0,a.jsx)(n.h2,{id:"setting-up-foreman",children:"Setting up Foreman"}),"\n",(0,a.jsx)(n.p,{children:"We'll be taking a somewhat unconventional approach to setting up Foreman - setting it up normally, then building Kubernetes, then using Kubernetes to host Foreman's database. Finally, we'll set up a highly available set of HAProxy nodes to service Kubernetes and Foreman."}),"\n",(0,a.jsx)(n.p,{children:"Once that's all complete, we'll use Foreman's Smart Proxy system to deploy a satellite node on each VLAN that we wish to deploy machines to, allowing us to automate installation of any part of Riff Labs."}),"\n",(0,a.jsx)(n.h3,{id:"creating-a-new-vm",children:"Creating a new VM"}),"\n",(0,a.jsxs)(n.p,{children:["We'll create a new node, which we'll call ",(0,a.jsx)(n.code,{children:"foreman01"}),", which will host our initial Foreman installation. Technically, you can install multiple services or groups of software on the same machine, but keeping things separate results in systems that are more predictable, sane and easy to manage."]}),"\n",(0,a.jsxs)(n.p,{children:["Create a new VM called ",(0,a.jsx)(n.code,{children:"foreman01"})," with 4 vCPUs, 80GiB of disk and 8192MiB of RAM and install Debian on it as before. Note: Foreman currently requires Debian ",(0,a.jsx)(n.em,{children:(0,a.jsx)(n.strong,{children:"11"})}),", not 12, so make sure you use Debian Bullseye instead of Bookworm."]}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsx)(n.p,{children:"You can provide a VM with less RAM while allowing it to use more RAM when necessary. This is very useful if you have processes that use RAM only some of the time."})}),"\n",(0,a.jsx)(n.p,{children:"Once your VM has been created and is ready to go, grab its IP address (which should be visible in Proxmox) and set it as a static DHCP lease in Gravity (our DNS + DHCP service from earlier), and ensure there is a DNS entry for it."}),"\n",(0,a.jsx)(n.h3,{id:"installing-foreman",children:"Installing Foreman"}),"\n",(0,a.jsxs)(n.p,{children:["Follow the Foreman install guide ",(0,a.jsx)(n.a,{href:"https://theforeman.org/manuals/3.10/quickstart_guide.html",children:"here"}),", then proceed to install Foreman."]}),"\n",(0,a.jsx)(n.p,{children:"You'll need to replace the values with sane values for your cluster."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'sudo foreman-installer \\\n--enable-foreman-proxy \\\n--foreman-proxy-tftp=true \\\n--foreman-proxy-tftp-servername=foreman.riff.cc \\\n--foreman-proxy-dhcp=true \\\n--foreman-proxy-dhcp-interface=enp6s18 \\\n--foreman-proxy-dhcp-gateway=10.1.1.1 \\\n--foreman-proxy-dhcp-nameservers="10.1.1.151,10.1.1.152,10.1.1.153"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["You may see an issue about a missing locale (",(0,a.jsx)(n.code,{children:"en_US.utf8"}),"). If this is the case, run ",(0,a.jsx)(n.code,{children:"dpkg-reconfigure locales"}),", enable the missing locale, reboot, and then re-run the installer."]}),"\n",(0,a.jsx)(n.h3,{id:"configuring-foreman",children:"Configuring Foreman"}),"\n",(0,a.jsx)(n.h4,{id:"subnets",children:"Subnets"}),"\n",(0,a.jsx)(n.p,{children:"Log in with the credentials provided, then go to Infrastructure -> Subnets"}),"\n",(0,a.jsx)(n.p,{children:"Create a subnet as follows (replacing all the details as needed):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"Name: RiffLabs Legacy\nDescription: Legacy network for RiffLabs\nProtocol: IPv4\nNetwork Address: 10.1.0.0\nNetwork Prefix: 16\nNetwork Mask: 255.255.0.0\nGateway Address: 10.1.1.1\nPrimary DNS Server: 10.1.1.151\nSecondary DNS Server: 10.1.1.152\nIPAM: None\nVlan Id: 1\nMTU: 1500\nBoot Mode: static\n"})}),"\n",(0,a.jsx)(n.p,{children:"Click Domains and associate the domain you selected earlier"}),"\n",(0,a.jsx)(n.p,{children:"Click Proxies and select the default in the dropdowns for each."}),"\n",(0,a.jsx)(n.h4,{id:"location-and-organisation",children:"Location and Organisation"}),"\n",(0,a.jsx)(n.p,{children:"Go to Administer -> Locations and rename the default location, then to Organizations and rename the default Organization."})]})}function c(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},7555:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/bootsception-4f2a98b33503737d9f3c88d774d46424.png"},1151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>r});var a=t(7294);const o={},i=a.createContext(o);function r(e){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);